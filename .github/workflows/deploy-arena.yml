name: Deploy Arena

on:
  push:
    branches:
      - master
      - vpk
    paths:
      - 'src/Lone-Arena-DMA-Radar/**'
      - '.github/workflows/deploy-arena.yml'
  workflow_dispatch:

permissions:
  contents: write

concurrency:
  group: arena-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build-arena:
    name: Build & Deploy Arena
    runs-on: ubuntu-latest
    environment: dev

    steps:
      - name: Checkout
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Get version info
        uses: dotnet/nbgv@master
        id: nbgv

      - name: Setup .NET SDK
        uses: actions/setup-dotnet@v5
        with:
          dotnet-version: |
            8.0.x
            10.0.x

      - name: Install Velopack CLI
        run: |
          dotnet tool install -g vpk
          echo "$HOME/.dotnet/tools" >> "$GITHUB_PATH"

      - name: Publish Arena
        run: |
          dotnet publish src/Lone-Arena-DMA-Radar/Lone-Arena-DMA-Radar.csproj \
            -c Release -r win-x64 --no-self-contained \
            /p:PublishSingleFile=true /p:DebugType=none /p:EnableWindowsTargeting=true \
            /p:Version=${{ steps.nbgv.outputs.SemVer2 }} \
            /p:FileVersion=${{ steps.nbgv.outputs.AssemblyFileVersion }} \
            /p:AssemblyVersion=${{ steps.nbgv.outputs.AssemblyVersion }} \
            -o out

      - name: Download previous release data
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          vpk download github \
            --repoUrl "https://github.com/${{ github.repository }}" \
            --outputDir "Releases/Arena" \
            --token "$GITHUB_TOKEN"

      - name: Pack Arena
        run: |
          vpk [win] pack \
            --packId github.lonedma.arena \
            --packVersion "${{ steps.nbgv.outputs.SemVer2 }}" \
            --packDir "out" \
            --mainExe "Lone-Arena-DMA-Radar.exe" \
            --outputDir "Releases/Arena" \
            --packTitle "Lone Arena DMA Radar" \
            --icon "Resources/lone-icon.ico"

      - name: Upload Arena
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          vpk upload github \
            --repoUrl "https://github.com/${{ github.repository }}" \
            --outputDir "Releases/Arena" \
            --publish \
            --merge \
            --releaseName "Arena ${{ steps.nbgv.outputs.SemVer2 }}" \
            --tag "v${{ steps.nbgv.outputs.SemVer2 }}" \
            --targetCommitish "${{ github.sha }}" \
            --token "$GITHUB_TOKEN"
